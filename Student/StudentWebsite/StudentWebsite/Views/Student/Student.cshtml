
@{
    ViewBag.Title = "Student";
}

<div class="row">
    <div class="col-sm-12">
        <div class="card">
            <div class="card-header">
                <h4 class="card-title">Student List</h4>
            </div>
            <div class="card-body">

                <div class="row" style="margin-bottom:2em;">
                    <div class="float-end">
                        @using (Html.BeginForm("ExportStudentData", "Student", FormMethod.Post))
                        {
                            <button id="btnExportData" class="btn btn-success waves-effect pull-right" style="margin-left:1em;">Export</button>
                            
                        }

                    </div>
                    <div class="float-end">
                        <button type="submit" id="btnRegisterStudent" class="btn btn-success waves-effect pull-right">Register student</button>    
                    </div>
                </div>
                <div class="row">
                    <div class="col-sm-12">
                        <div class="table-responsive">
                            <table id="tblStudent" class="table table-bordered">
                                <thead>
                                    <tr>
                                        <th>Sr No</th>
                                        <th>Joining Date</th>
                                        <th>Student name</th>
                                        <th>Address</th>
                                        <th>Class</th>
                                        <th>Age</th>
                                        <th>Hobbies</th>
                                        <th>Gender</th>
                                        <th>State</th>
                                        <th>City</th>
                                        <th>Pincode</th>
                                        <th>Photo</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="modalConfirm" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLongTitle-1">
                    Confirmation
                </h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">
                        &times;
                    </span>
                </button>
            </div>
            <div class="modal-body">
                <h5>Are you sure ?</h5>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-dismiss="modal">
                    No
                </button>
                <button type="button" id="btnSaveChanges" class="btn btn-primary">
                    Yes
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="mdlAddUpdate" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <form id="addupdate" data-parsley-validate="" enctype="multipart/form-data">
                <div class="modal-header">
                    <h5 class="modal-title" id="lblModalTitle">
                        Confirmation
                    </h5>
                    <button type="button" class="close reset" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">
                            &times;
                        </span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group mb-0">
                        <label class="mb-0">Student Name</label>
                        <input type="text" id="txtStudentName" class="form-control mb-2" required data-parsley-maxlength="50" placeholder="Enter student name">
                    </div>

                    <div class="form-group mb-0">
                        <label class="mb-0">Address</label>
                        <textarea id="txtAddress" class="form-control mb-2" required data-parsley-maxlength="100" placeholder="Enter address"></textarea>
                    </div>

                    <div class="form-group mb-0">
                        <label class="mb-0">Class</label>
                        <select class="input-group mb-2" id="ddlClass" required>
                            <option value="">--Select--</option>
                            <option value="1">1st</option>
                            <option value="2">2nd</option>
                            <option value="3">3rd</option>
                            <option value="4">4th</option>
                            <option value="5">5th</option>
                            <option value="6">6th</option>
                            <option value="7">7th</option>
                            <option value="8">8th</option>
                            <option value="9">9th</option>
                            <option value="10">10th</option>
                            <option value="11">11th</option>
                            <option value="12">12th</option>
                        </select>
                    </div>

                    <div class="form-group mb-0">
                        <label class="mb-0">Age</label>
                        <input type="number" id="txtAge" class="form-control mb-2" required placeholder="Enter age">
                    </div>

                    <div class="form-group mb-0">
                        <label class="mb-0">Gender</label>
                        <input type="radio" name="txtGender" value="Female" required /> Female
                        <input type="radio" name="txtGender" value="Male" /> Male
                    </div>

                    <div class="form-group mb-0">
                        <label class="mb-0">Hobbies</label>
                        <input type="checkbox" data-parsley-checkmin="1" required name="txtHobbies" value="Dancing" /> Dancing
                        <input type="checkbox" name="txtHobbies" value="Drawing" /> Drawing
                        <input type="checkbox" name="txtHobbies" value="Singing" /> Singing
                    </div>

                    <div class="form-group mb-0">
                        <div class="row">
                            <div class="col-lg-3">
                                <label class="mb-0">State</label>
                                <select id="ddlState" required>
                                    <option value="">--Select--</option>
                                </select>
                            </div>

                            <div class="col-lg-3">
                                <label class="mb-0">City</label>
                                <select class="input-group mb-2" id="ddlCity" required>
                                    <option value="">--Select--</option>
                                </select>
                            </div>


                        </div>
                    </div>

                    <div class="form-group mb-0">
                        <label class="mb-0">Pincode</label>
                        <input type="number" id="txtPincode" class="form-control mb-2" required data-parsley-maxlength="6" placeholder="Enter pincode">
                    </div>

                    <div class="form-group mb-0" id="insertFile">
                        <label class="mb-0">Photo</label>
                        <input type="file" class="form-control mb-2" required placeholder="Enter pincode" name="file" id="file">
                        <img src="" id="imgPhoto" height="100" width="100"/>
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger reset" data-dismiss="modal">
                        Cancel
                    </button>
                    <button type="button" id="btnAddUpdate" class="btn btn-primary">
                        Register student
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section scripts
    {
    <script src="~/Content/plugins/parsleyjs/parsley.min.js"></script>
    <script>
        $(document).ready(function () {
            fnStudentList();
        });

        $("#ddlState").change(function () {
            GetCity($("#ddlState").val());
        });


        $('body').on('click', '#btnActionStatus', function () {
            id = $(this).data('id');
            $("#modalConfirm").modal("show");
        });

        $('body').on('click', '#btnActionUpdate', function () {
            id = $(this).data('id');
            $.ajax({
                type: "GET",
                url: "/Student/GetStudentById?id=" + id,
                dataType: 'json',
                contentType: false,
                processData: false,
                success: function (data) {
                    reserValues();
                    $("#lblModalTitle").html("Update student data");
                    $("#btnAddUpdate").html("Update student data");
                    $("[name=file]").removeAttr("required");
                    $('#file').text(data.Photo);
                    $("#txtStudentName").val(data.StudentName);
                    var hobbies = data.Hobbies.toString().split(',');

                    $.each(hobbies, function (i, val) {

                        $("input[value='" + val + "']").prop('checked', true);

                    });
                    $("#txtHobbies").val();
                    $("#txtAddress").val(data.Address);
                    $("#ddlClass").val(data.Class);
                    $("#txtAge").val(data.Age);
                    $("input[name=txtGender][value=" + data.Gender + "]").prop('checked', true);
                    GetStateUpdate(data.StateId);

                    GetCityUpdate(data.StateId, data.CityId);

                    $("#txtPincode").val(data.Pincode);
                    
                    $('#imgPhoto').show();
                    $('#imgPhoto').attr('src', '../Content/StudentPhoto/' + data.Photo);


                    val = data.Name;
                    isadd = false;
                    $("#mdlAddUpdate").modal({ backdrop: 'static', keyboard: false });
                    $('#mdlAddUpdate').modal('show');
                },
                error: function () {
                    toastr.error('Something went wrong.');
                }
            });
        });

        $('body').on('click', '#btnSaveChanges', function () {
            var formData = new FormData();
            formData.append("id", id);
            $.ajax({
                type: "POST",
                url: "/Student/DeleteStudent",
                dataType: 'json',
                contentType: false,
                processData: false,
                data: formData,
                success: function (data) {
                    $('#modalConfirm').modal('hide');
                    $('#tblStudent').DataTable().ajax.reload(null, false);
                    toastr.success('Operation successfully completed.');
                },
                error: function () {
                    toastr.error('Something went wrong.');
                }
            });
        });

        $('body').on('click', '#btnRegisterStudent', function () {
            $("#lblModalTitle").html("Register student");
            $("#btnAddUpdate").html("Register student");
            GetState();
            $("[name=file]").attr("required", "required");
            $('#imgPhoto').attr('src', '');
            $('#imgPhoto').hide();
            $("#mdlAddUpdate").modal({ backdrop: 'static', keyboard: false });
            $("#mdlAddUpdate").modal("show");
            isadd = true;
            reserValues();
        });

        $('body').on('click', '#btnAddUpdate', function () {
            var form = $('#addupdate').parsley();

            if (form.isValid()) {

                var hobbies = $('input[name="txtHobbies"]:checked').map(function () {
                    return this.value;
                }).get().join(",");

                var formData = new FormData();
                formData.append("StudentName", $("#txtStudentName").val());
                formData.append("Address", $("#txtAddress").val());
                formData.append("Class", $("#ddlClass").val());
                formData.append("Age", $("#txtAge").val());
                formData.append("Gender", $('input[name="txtGender"]:checked').val());
                formData.append("CityId", $("#ddlCity").val());
                formData.append("Pincode", $("#txtPincode").val());
                formData.append("Hobbies", hobbies);
                var fileInput = document.getElementById('file');
                if (fileInput != "" && fileInput.files.length > 0) {
                    for (i = 0; i < fileInput.files.length; i++) {
                        formData.append(fileInput.files[i].name, fileInput.files[i]);
                    }
                }
                if (isadd) {

                    $.ajax({
                        type: "POST",
                        url: "/Student/RegisterStudent",
                        dataType: 'json',
                        contentType: false,
                        processData: false,
                        data: formData,
                        success: function (data) {
                            if (data.Status) {
                                $('#mdlAddUpdate').modal('hide');
                                $('#tblStudent').DataTable().ajax.reload(null, false);
                                toastr.success('Student added successfully.');
                            }
                            else {
                                toastr.error('Something went wrong.');
                            }
                        },
                        error: function () {
                            toastr.error('Something went wrong.');
                        }
                    });
                }
                else {
                    formData.append("id", id);
                    $.ajax({
                        type: "POST",
                        url: "/Student/UpdateStudent",
                        dataType: 'json',
                        contentType: false,
                        processData: false,
                        data: formData,
                        success: function (data) {
                            $('#mdlAddUpdate').modal('hide');
                            $('#tblStudent').DataTable().ajax.reload(null, false);
                            toastr.success('Student updated successfully.');
                        },
                        error: function () {
                            toastr.error('Something went wrong.');
                        }
                    });
                }
            }
            else {
                    $('#addupdate').submit();
            }
            $('.parsley-required').addClass('text-danger');
            $('.parsley-maxlength').addClass('text-danger');
        });

        function reserValues() {
            $("#txtStudentName").val("");
            $("#txtHobbies").val("");
            $("#txtAddress").val("");
            $("#ddlClass").val("");
            $("#txtAge").val("");
            $('input[name="txtGender"]:checked').val("");
            $("#txtPincode").val("");
            $("[name=file]").attr("required", "required");
            $('#imgPhoto').attr('src', '');
            $('#imgPhoto').hide();
            form = $('#addupdate').parsley().reset();
        }

        function GetStateUpdate(stateId) {
            $.ajax({
                url:'@Url.Action("GetStateList", "Student")',
                type: "GET",
                success: function (response) {
                    if (response.length > 0) {
                        $('#ddlState').html('');
                        var options = '';
                        options += '<option value="">--Select--</option>';
                        $(response).each(function (index, element) {
                            if (element.Id == stateId) {
                                options += '<option selected value="' + element.Id + '">' + element.StateName + '</option>';
                            }
                            else
                            options += '<option value="' + element.Id + '">' + element.StateName + '</option>';
                        });
                        $('#ddlState').html(options);
                    }
                    else {
                        toastr.error("Something went wrong!");
                    }
                },
                error: function (result) {
                    toastr.error("Something went wrong!");
                }
            });
        }

        function GetState() {
            $.ajax({
                url:'@Url.Action("GetStateList", "Student")',
                type: "GET",
                success: function (response) {
                    if (response.length > 0) {
                        $('#ddlState').html('');
                        var options = '';
                        options += '<option value="">--Select--</option>';
                        $(response).each(function (index, element) {
                            options += '<option value="' + element.Id + '">' + element.StateName + '</option>';
                        });
                        $('#ddlState').html(options);
                    }
                    else {
                        toastr.error("Something went wrong!");
                    }
                },
                error: function (result) {
                    toastr.error("Something went wrong!");
                }
            });
        }

        function GetCity(state) {
            $.ajax({
                url:'@Url.Action("GetCityByState", "Student")?state=' + state,
                type: "GET",
                success: function (response) {
                    if (response.length > 0) {
                        $('#ddlCity').html('');
                        var options = '';
                        options += '<option value="">--Select--</option>';
                        $(response).each(function (index, element) {
                            options += '<option value="' + element.Id + '">' + element.CityName + '</option>';
                        });


                        $('#ddlCity').html(options);

                    }
                    else {
                        toastr.error("Something went wrong!");
                    }
                },
                error: function (result) {
                    toastr.error("Something went wrong!");
                }
            });
        }

        function GetCityUpdate(state,city) {
            $.ajax({
                url:'@Url.Action("GetCityByState", "Student")?state=' + state,
                type: "GET",
                success: function (response) {
                    if (response.length > 0) {
                        $('#ddlCity').html('');
                        var options = '';
                        options += '<option value="">--Select--</option>';
                        $(response).each(function (index, element) {
                            if (element.Id == city) {
                                options += '<option selected value="' + element.Id + '">' + element.CityName + '</option>';
                            }
                            else
                                options += '<option value="' + element.Id + '">' + element.CityName + '</option>';
                        });


                        $('#ddlCity').html(options);

                    }
                    else {
                        toastr.error("Something went wrong!");
                    }
                },
                error: function (result) {
                    toastr.error("Something went wrong!");
                }
            });
        }


        function fnStudentList() {
            var t = $('#tblStudent').DataTable({
                "retrieve": true,
                "destroy": true,
                //"info": false,
                "ordering": true,
                "language":
                {
                    "processing":
                        "<div class='overlay custom-loader-background' style='color:black;'>Please Wait...</div>"
                },
                "processing": true,
                "serverSide": true,
                "ajax":
                {
                    "url": "/Student/StudentList",
                    "type": "POST",
                    "dataType": "JSON"
                },
                "columns": [
                    {
                        mRender: function (data, type, full) {
                            return "";
                        }
                    },
                    {

                        data: null,
                        render: function (data, type, row) {
                            var activeUtc = moment(data.RegistrationDate).toDate();

                            var time = moment(activeUtc).local().format('MMM-DD-YYYY');
                            return time;
                        }
                    },
                    { "data": "StudentName", "autoWidth": true },
                    { "data": "Address", "autoWidth": true },
                    { "data": "Class", "autoWidth": true },
                    { "data": "Age", "autoWidth": true },
                    { "data": "Hobbies", "autoWidth": true },
                    { "data": "Gender", "autoWidth": true },
                    { "data": "StateName", "autoWidth": true },
                    { "data": "CityName", "autoWidth": true },
                    { "data": "Pincode", "autoWidth": true },
                    {
                        data: null,
                        render: function (data, type, row) {
                            var img = "<img src='../Content/StudentPhoto/" + data.Photo + "' class='rounded-circle' alt='' width='100' height='100'/>"
                            return img;
                        }
                    },
                    {
                        data: null,
                        autoWidth: true,
                        sortable: false,
                        width: "220px",
                        render: function (data, type, row) {
                            var button;
                            if (!data.IsDeleted) {
                                button = '<button type="button" style="margin:2px;width: 105px;" id="btnActionStatus" data-id="' + data.Id + '" class="btn btn-danger waves-effect waves-light">Delete</button>';
                            }
                            else {
                                button = '<button type="button"  style="margin:2px;width: 105px;" id="btnActionStatus" data-id="' + data.Id + '" class="btn btn-success waves-effect waves-light">Restore</button>';
                            }

                            button += '<button type="button"  style="margin:2px; width: 105px;" id="btnActionUpdate" data-id="' + data.Id + '" class="btn btn-primary  waves-effect waves-light">Update</button>';
                            return button;
                        }
                    },
                ],
                "order": [[0, "desc"]],
                'columnDefs': [{

                    'targets': [0, 11], /* column index */

                    'orderable': false, /* true or false */
                }],
            });
            t.on('draw.dt',
                function () {
                    var PageInfo = $('#tblStudent').DataTable().page.info();
                    t.column(0, { page: 'current' }).nodes().each(function (cell, i) {
                        cell.innerHTML = i + 1 + PageInfo.start;
                    });
                });
        }
    </script>
}
